<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    <script type="text/javascript" src="http://webapi.amap.com/maps?v=1.3&key=6525c2040f1c294c65e6cd15f513620c&&plugin=AMap.Scale,AMap.OverView,AMap.ToolBar"></script>
    <link rel="stylesheet" href="http://cache.amap.com/lbs/static/main1119.css" />
    <script src="http://cache.amap.com/lbs/static/es5.min.js"></script>
    <!-- 新 Bootstrap 核心 CSS 文件 -->
    <!--<link href="//cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">-->

    <script type="text/javascript" src="http://cache.amap.com/lbs/static/addToolbar.js"></script>
    <style type="text/css">
        #container {
            height: 90%;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="container"></div>
        <div class="col-md-6 col-md-offset-2 button-group" style="background-color:darkslateblue; right: 125px">
            <input type="file" id="file-input" />
            <input type="button" id="clear" value="Clear" />
            <span id="info"></span>
            <input type="text" id="company-filter" />
            <input type="button" id="btn-company-filter" value="过滤" />
            <input type="text" name="slt-filter" list="company-list" id="slt-filter" />
            Price >=
            <input type="text" id="lowest-price" style="width: 50px"/>
            Price <=
            <input type="text" id="largest-price" style="width: 50px"/>
            <datalist id='company-list'></datalist>
            <input type="button" id="btn-fitview" value="自适应缩放" />
        </div>
    </div>

    <!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
    <!--<script src="//cdn.bootcss.com/jquery/3.1.0/jquery.min.js"></script>-->
    <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
    <!--<script src="//cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>-->
    <script type="text/javascript">
        var heatPoints = [];
        var heatPointNames = {};
		var filteredPoints = [];
        var cluster;

        var map = new AMap.Map('container');

        currentZoom = 10;

        map.setZoom(currentZoom);
        map.setCenter([115.39, 39.9]);

        initializeMap();
        AMap.event.addListener(map, 'zoomend', onMapZooming);

        function initializeMap() {
            AMap.plugin(['AMap.ToolBar', 'AMap.Scale'], function () {
                var toolBar = new AMap.ToolBar();
                var scale = new AMap.Scale();
                map.addControl(toolBar);
                map.addControl(scale);
            })



            AMap.event.addDomListener(document.getElementById('clear'), 'click', function () {
                if (cluster) {
                    cluster.setMap(null);
                }
                heatPoints = [];
            })

            AMap.event.addDomListener(document.getElementById('btn-company-filter'), 'click', function () {
                clearMap();
                var companyName = getFilterValue();
                for (var i = 0; i < heatPoints.length; i++) {
                    var point = heatPoints[i];
                    if(isMatchedPoint(point)) {
                        if(map.getZoom() >= 15) {
							point.setMap(map);
						}
						filteredPoints.push(point);
                    }
                }
				if(map.getZoom() < 15) {
					addCluster(filteredPoints);
				}
            });

			AMap.event.addDomListener(document.getElementById('btn-fitview'), 'click', function() {
				var slt_value = document.getElementById("slt-filter");
				alert(slt_value.value);
			});

			document.getElementById('company-filter').addEventListener("keyup", function(event) {
				event.preventDefault();
				if(event.keyCode == 13) {
					document.getElementById("btn-company-filter").click();
				}
			});
        }

        document.getElementById('file-input').addEventListener('change', readSingleFile, false);


        function readSingleFile(e) {
            heatPoints = [];
            clearMap();
            var file = e.target.files[0];
            if (!file) {
                return;
            }
            var reader = new FileReader();
            reader.onload = function (e) {
                var contents = e.target.result;
                processData(contents);
            };
            reader.readAsText(file);
        }

        function processData(allText) {
            var allTextLines = allText.split(/\r\n|\n/);
            var divContents = document.getElementById('result');
            var contents = [];
			var companies = [];
            for (var i = 1; i < allTextLines.length; i++) {
                var sections = allTextLines[i].split(',');
                if (sections.length > 2) {
                    var addr = sections[0];
                    var cell = sections[1];
                    var lng = sections[2];
                    var lat = sections[3];
                    var price = sections[5];
                    var company = sections[7];
                    var houseId = sections[8];
					var compList = document.getElementById("company-list");
					if(!(company in companies)) {
						compList.innerHTML += '<option value="' + company + '">';
						companies.push(company);
					}


					var infoText = "<b>Addr</b>: <a target='_blank' href='http://bj.ganji.com/fang1/" + houseId + ".htm'>" + addr + "</a></br><b>Price:</b> " + price + "</br><b>Company:</b> " + company;
                    if (!lng || !lat) {
                        continue;
                    }

                    var number = 1;
                    var markerPosition = [lng, lat];
                    try {
                        var my_offset = 50;
                        var x_offset = -30;
                        var y_offset = -30;
                        if (cell in heatPointNames) {
                            var x_times = heatPointNames[cell] / 4;
                            var y_times = heatPointNames[cell] % 4;
                            if (y_times == 1) {
                                x_offset -= x_times * my_offset;
                            } else if (y_times == 2) {
                                x_offset += x_times * my_offset;
                            } else if (y_times == 3) {
                                y_offset -= x_times * my_offset;
                            } else {
                                y_offset += x_times * my_offset;
                            }
                            heatPointNames[cell] += 1;
                        } else {
                            heatPointNames[cell] = 1;
                        }
                        var marker = new AMap.Marker({
                            position: markerPosition
							, icon: "http://amappc.cn-hangzhou.oss-pub.aliyun-inc.com/lbs/static/img/marker.png"
							, title: infoText
							, offset: { x: x_offset, y: y_offset }
                        })
                        marker.setLabel({
                            offset: new AMap.Pixel(x_offset+20, y_offset+20)
							, content: cell
                        });
                        AMap.event.addListener(marker, 'click', onMarkerClick);
                        heatPoints.push(marker);
						if(isMatchedPoint(marker)) {
							filteredPoints.push(marker);
						}
                        //marker.setMap(map);
                    } catch (e) {
                        continue;
                    }
                }
            }
            addCluster(heatPoints);
        }

        function onMapZooming() {
            var oldZoom = currentZoom;
            currentZoom = map.getZoom();
            map.clearMap();
            document.getElementById('info').innerHTML = 'Zoom：' + currentZoom;
            if (currentZoom >= 15) {
                if (cluster) {
                    cluster.setMap(null);
                    cluster = null;
                }

                for (var i = 0; i < filteredPoints.length; i++) {

					var marker = new AMap.Marker({
						position: filteredPoints[i].getPosition()
							, icon: "http://amappc.cn-hangzhou.oss-pub.aliyun-inc.com/lbs/static/img/marker.png"
							, title: filteredPoints[i].getTitle()
							, offset: filteredPoints[i].getOffset()
					})
					marker.setLabel({
						offset: new AMap.Pixel(20, 20)
						, content: filteredPoints[i].getLabel().content
					});

					AMap.event.addListener(marker, 'click', onMarkerClick);
					marker.setMap(map);

                }
            } else {
                if (!cluster) {
                    addCluster(filteredPoints);
                }
            }
        }

        function onMarkerClick(e) {
            var mk = e.target;
            var infoWindow = new AMap.InfoWindow({ offset: new AMap.Pixel(0, -30) });
            infoWindow.setContent(mk.getTitle());
            infoWindow.setOffset(mk.getOffset());
            infoWindow.open(map, mk.getPosition());
        }

        function addCluster(points) {
            if (cluster) {
                cluster.setMap(null);
            }
            map.plugin(
                ['AMap.MarkerClusterer']
                , function () {
                    cluster = new AMap.MarkerClusterer(map, points);
                }
            );
        }

        function getFilterValue() {
            var filter_value = {};
            var filter_company = document.getElementById('company-filter').value;
		    var filter_largest_price = document.getElementById('largest-price').value;
		    var filter_lowest_price = document.getElementById('lowest-price').value;
		    return {
		        'company': filter_company.trim()
                , 'largest_price': filter_largest_price.trim()
                , 'lowest_price': filter_lowest_price.trim()
		    }
		}

        function isMatchedPoint(point) {
            var filters = getFilterValue();
            var result = true;
            for (key in filters) {
                var value = filters[key];
                if (value == "") {
                    continue;
                }
                if (key == "company") {
                    if (point.getTitle().indexOf(value) == -1) {
                        return false;
                    }
                } else if (key == "largest_price") {
                    var cur_price = getPriceFromMarkerTitle(point);
                    if (cur_price > value) {
                        return false;
                    }
                } else if (key == "lowest_price") {
                    var cur_price = getPriceFromMarkerTitle(point);
                    if (cur_price < value) {
                        return false;
                    }
                }
            }
            return result;
        }

        function getPriceFromMarkerTitle(marker) {
            var title = marker.getTitle();
            var lines = title.split("</br>");
            for (var i = 0; i < lines.length; i++) {
                var pair = lines[i].split(' ');
                var key = pair[0].trim();
                if (key.includes("Price")) {
                    return parseInt(pair[1].trim());
                }
            }
        }

        function clearMap() {
            map.clearMap();
			filteredPoints = [];
        }

    </script>
</body>
</html>